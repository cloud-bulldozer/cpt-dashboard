/*
AI assistance: The Summary UI code was completely generated by Cursor with
Claude 4 Sonnet. The final form is the result of an interactive dialog between
human and AI assistant, with no manual edits.

Assisted-by: Cursor + claude-4-sonnet
*/
import {
  Card,
  CardBody,
  Grid,
  GridItem,
  Title,
  DescriptionList,
  DescriptionListTerm,
  DescriptionListDescription,
  DescriptionListGroup,
  Select,
  SelectList,
  SelectOption,
  MenuToggle,
  Spinner,
} from "@patternfly/react-core";
import { Td, Tr } from "@patternfly/react-table";
import { useState, useCallback } from "react";
import { useDispatch, useSelector } from "react-redux";
import PropTypes from "prop-types";
import PlotGraph from "@/components/atoms/PlotGraph";

const SummaryBenchmarkExpandedRow = ({ product, version, benchmark, benchmarkData }) => {
  const dispatch = useDispatch();
  const summaryState = useSelector((state) => state.summary || {});
  const { summaryData, startDate, endDate } = summaryState;

  const [selectedConfig, setSelectedConfig] = useState(
    benchmarkData.configs?.sort()?.[0] || "",
  );
  const [selectedIteration, setSelectedIteration] = useState("");
  const [isConfigSelectOpen, setIsConfigSelectOpen] = useState(false);
  const [isIterationSelectOpen, setIsIterationSelectOpen] = useState(false);
  const [isLoadingData, setIsLoadingData] = useState(false);

  // Get available iterations for the selected configuration
  const getAvailableIterations = () => {
    if (!selectedConfig || !benchmarkData.configData?.[selectedConfig]) {
      return [];
    }
    return Object.keys(benchmarkData.configData[selectedConfig]);
  };

  const availableIterations = getAvailableIterations();

  // Set default iteration if not selected
  if (!selectedIteration && availableIterations.length > 0) {
    const sortedIterations = availableIterations.sort((a, b) => Number(a) - Number(b));
    setSelectedIteration(sortedIterations[0]);
  }

  // Get the summary data for this combination (include config and iteration for uniqueness)
  const dataKey = `${product}-${version}-${benchmark}-${selectedConfig}-${selectedIteration}`;
  const currentSummaryData = summaryData[dataKey];

  // Dynamically import actions
  const fetchSummaryData = useCallback(async (product, version, benchmark, config, iteration, beginDate, endDate) => {
    setIsLoadingData(true);
    try {
      const { fetchSummaryData: fetchData } = await import("@/actions/summaryActions");
      await dispatch(fetchData(product, version, benchmark, config, iteration, beginDate, endDate));
    } finally {
      setIsLoadingData(false);
    }
  }, [dispatch]);

  const formatStatValue = (value) => {
    if (value === null || value === undefined) return "N/A";
    if (typeof value === "number") return value.toLocaleString();
    return value;
  };

  const handleConfigSelect = (_event, value) => {
    setSelectedConfig(value);
    setIsConfigSelectOpen(false);
    // Reset iteration selection when config changes
    const newIterations = benchmarkData.configData?.[value] ? Object.keys(benchmarkData.configData[value]) : [];
    if (newIterations.length > 0) {
      const sortedIterations = newIterations.sort((a, b) => Number(a) - Number(b));
      setSelectedIteration(sortedIterations[0]);
    } else {
      setSelectedIteration("");
    }
  };

  const handleIterationSelect = (_event, value) => {
    setSelectedIteration(value);
    setIsIterationSelectOpen(false);
  };

  // Fetch data when component mounts or selections change
  const handleFetchData = () => {
    if (selectedConfig && selectedIteration) {
      fetchSummaryData(product, version, benchmark, selectedConfig, selectedIteration, startDate, endDate);
    }
  };

  const configToggle = (toggleRef) => (
    <MenuToggle
      ref={toggleRef}
      onClick={() => setIsConfigSelectOpen(!isConfigSelectOpen)}
      isExpanded={isConfigSelectOpen}
      style={{ width: "300px" }}
    >
      {selectedConfig ? `Config: ${selectedConfig}` : "Select Configuration"}
    </MenuToggle>
  );

  const iterationToggle = (toggleRef) => (
    <MenuToggle
      ref={toggleRef}
      onClick={() => setIsIterationSelectOpen(!isIterationSelectOpen)}
      isExpanded={isIterationSelectOpen}
      style={{ width: "200px" }}
    >
      {selectedIteration
        ? `Iterations: ${selectedIteration}`
        : "Select Iteration Count"}
    </MenuToggle>
  );

  // Extract data for the selected configuration and iteration
  const getSelectedData = () => {
    if (!currentSummaryData || !selectedConfig || !selectedIteration) {
      return null;
    }

    console.log(`Looking for data in currentSummaryData:`, currentSummaryData);
    console.log(`Selected config: ${selectedConfig}, iteration: ${selectedIteration}`);
    
    // Navigate the API response structure: product -> metrics -> version -> benchmark -> config -> iteration
    const productData = currentSummaryData[product];
    if (!productData) {
      console.log(`No data found for product: ${product}`);
      return null;
    }

    const metricsData = productData.metrics;
    if (!metricsData) {
      console.log(`No metrics data found in product data`);
      return null;
    }

    const versionData = metricsData[version];
    if (!versionData) {
      console.log(`No data found for version: ${version}`);
      return null;
    }

    const benchmarkData = versionData[benchmark];
    if (!benchmarkData) {
      console.log(`No data found for benchmark: ${benchmark}`);
      return null;
    }

    const configData = benchmarkData[selectedConfig];
    if (!configData) {
      console.log(`No data found for config: ${selectedConfig}`);
      return null;
    }

    const iterationData = configData[selectedIteration];
    if (!iterationData) {
      console.log(`No data found for iteration: ${selectedIteration}`);
      return null;
    }

    console.log(`Found iteration data:`, iterationData);
    return iterationData;
  };

  const selectedData = getSelectedData();

  return (
    <Tr data-level="3">
      <Td />
      <Td colSpan={3} style={{ padding: "1rem 2rem" }}>
        <div className="summary-expanded-content">
          <Card>
            <CardBody>
              <Title
                headingLevel="h4"
                size="lg"
                style={{ marginBottom: "1rem" }}
              >
                {product} - {version} - {benchmark}
              </Title>

              {/* Configuration and Iteration Selectors */}
              <Grid
                hasGutter
                className="selector-grid"
                style={{ marginBottom: "1rem" }}
              >
                <GridItem span={4}>
                  <Title
                    headingLevel="h6"
                    size="sm"
                    style={{ marginBottom: "0.5rem" }}
                  >
                    Select Configuration:
                  </Title>
                  <Select
                    isOpen={isConfigSelectOpen}
                    selected={selectedConfig}
                    onSelect={handleConfigSelect}
                    onOpenChange={(isOpen) => setIsConfigSelectOpen(isOpen)}
                    toggle={configToggle}
                  >
                    <SelectList>
                      {benchmarkData.configs?.sort().map((config) => (
                        <SelectOption key={config} value={config}>
                          {config}
                        </SelectOption>
                      ))}
                    </SelectList>
                  </Select>
                </GridItem>

                {availableIterations.length > 1 && (
                  <GridItem span={4}>
                    <Title
                      headingLevel="h6"
                      size="sm"
                      style={{ marginBottom: "0.5rem" }}
                    >
                      Select Iteration Count:
                    </Title>
                    <Select
                      isOpen={isIterationSelectOpen}
                      selected={selectedIteration}
                      onSelect={handleIterationSelect}
                      onOpenChange={(isOpen) =>
                        setIsIterationSelectOpen(isOpen)
                      }
                      toggle={iterationToggle}
                    >
                      <SelectList>
                        {availableIterations.sort((a, b) => Number(a) - Number(b)).map((iteration) => {
                          const count = benchmarkData.configData?.[selectedConfig]?.[iteration] || 0;
                          return (
                            <SelectOption key={iteration} value={iteration}>
                              {iteration} iterations ({count} runs)
                            </SelectOption>
                          );
                        })}
                      </SelectList>
                    </Select>
                  </GridItem>
                )}

                <GridItem span={4}>
                  <Title
                    headingLevel="h6"
                    size="sm"
                    style={{ marginBottom: "0.5rem" }}
                  >
                    &nbsp;
                  </Title>
                  <button
                    className="pf-c-button pf-m-primary"
                    onClick={handleFetchData}
                    disabled={!selectedConfig || !selectedIteration || isLoadingData}
                    style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}
                  >
                    {isLoadingData && <Spinner size="sm" />}
                    {isLoadingData ? "Loading..." : "Load Data"}
                  </button>
                </GridItem>
              </Grid>

              {selectedConfig && selectedIteration && (
                <div style={{ marginBottom: "1rem", padding: "0.75rem", backgroundColor: "#f8f9fa", borderRadius: "4px", border: "1px solid #e9ecef" }}>
                  <strong>Selected Configuration:</strong> {selectedConfig}<br/>
                  <strong>Selected Iterations:</strong> {selectedIteration} iterations 
                  ({benchmarkData.configData?.[selectedConfig]?.[selectedIteration] || 0} runs available)
                </div>
              )}

              {selectedData && (
                <Grid hasGutter>
                  {/* Statistics Section */}
                  <GridItem span={6}>
                    <div className="stats-section">
                      <Title
                        headingLevel="h6"
                        size="sm"
                        style={{ marginBottom: "0.5rem" }}
                      >
                        Statistics ({selectedIteration} iterations)
                      </Title>
                      <DescriptionList isHorizontal>
                        <DescriptionListGroup>
                          <DescriptionListTerm>Minimum</DescriptionListTerm>
                          <DescriptionListDescription>
                            {formatStatValue(selectedData.stats?.min)}
                          </DescriptionListDescription>
                        </DescriptionListGroup>
                        <DescriptionListGroup>
                          <DescriptionListTerm>Maximum</DescriptionListTerm>
                          <DescriptionListDescription>
                            {formatStatValue(selectedData.stats?.max)}
                          </DescriptionListDescription>
                        </DescriptionListGroup>
                        <DescriptionListGroup>
                          <DescriptionListTerm>Average</DescriptionListTerm>
                          <DescriptionListDescription>
                            {formatStatValue(selectedData.stats?.avg)}
                          </DescriptionListDescription>
                        </DescriptionListGroup>
                        <DescriptionListGroup>
                          <DescriptionListTerm>Std Deviation</DescriptionListTerm>
                          <DescriptionListDescription>
                            {formatStatValue(selectedData.stats?.std_dev)}
                          </DescriptionListDescription>
                        </DescriptionListGroup>
                      </DescriptionList>

                      {/* Values List */}
                      {selectedData.values && selectedData.values.length > 0 && (
                        <>
                          <Title
                            headingLevel="h6"
                            size="sm"
                            style={{
                              marginTop: "1rem",
                              marginBottom: "0.5rem",
                            }}
                          >
                            Individual Values ({selectedData.values.length} runs)
                          </Title>
                          <div className="values-list">
                            {selectedData.values.map((valueData, index) => (
                              <div
                                key={`${valueData.uuid || 'no-uuid'}-${index}`}
                                className="value-item"
                              >
                                <span className="value">
                                  {valueData.value?.toLocaleString()}
                                </span>
                                {valueData.timestamp && (
                                  <span className="timestamp">
                                    (
                                    {new Date(
                                      valueData.timestamp,
                                    ).toLocaleString()}
                                    )
                                  </span>
                                )}
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                    </div>
                  </GridItem>

                  {/* Chart Section */}
                  <GridItem span={6}>
                    <div className="chart-section">
                      <Title
                        headingLevel="h6"
                        size="sm"
                        style={{ marginBottom: "0.5rem" }}
                      >
                        Performance Chart
                      </Title>
                      {selectedData.graph &&
                      selectedData.graph.x &&
                      selectedData.graph.x.length > 0 ? (
                        <PlotGraph data={[selectedData.graph]} />
                      ) : (
                        <div className="no-data-placeholder">
                          No chart data available
                        </div>
                      )}
                    </div>
                  </GridItem>
                </Grid>
              )}

              {!selectedData && selectedConfig && selectedIteration && !isLoadingData && (
                <div style={{ textAlign: "center", padding: "2rem" }}>
                  <p>Click "Load Data" to fetch metrics for the selected configuration.</p>
                </div>
              )}

              {isLoadingData && !selectedData && (
                <div style={{ textAlign: "center", padding: "2rem" }}>
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: "0.5rem" }}>
                    <Spinner size="md" />
                    <p>Fetching metrics data...</p>
                  </div>
                </div>
              )}
            </CardBody>
          </Card>
        </div>
      </Td>
    </Tr>
  );
};

SummaryBenchmarkExpandedRow.propTypes = {
  product: PropTypes.string.isRequired,
  version: PropTypes.string.isRequired,
  benchmark: PropTypes.string.isRequired,
  benchmarkData: PropTypes.object.isRequired,
};

export default SummaryBenchmarkExpandedRow;
